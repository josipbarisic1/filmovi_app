<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/pretrazi_film.css">
</head>
<body>
    <%- include('partials/header') %>

    <main>
        <h1 class="top-list-h1"><%= title %></h1>

        <% if (data && data.results.length > 0) { %>
            <div class="movie-grid">
                <% data.results.forEach(item => { %>
                    <a href="<%= category === 'movie' ? `/film/${item.id}` : `/serija/${item.id}` %>" class="movie-card-link">
                        <div class="movie-card">
                            <div class="movie-title-mobile">
                                <%= item.title || item.name %>
                                <% if (item.release_date || item.first_air_date) { %> 
                                    (<%= (item.release_date || item.first_air_date).substr(0, 4) %>)
                                <% } %>
                            </div>
                            <div class="poster-wrapper">
                                <img src="<%= item.poster_path ? `https://image.tmdb.org/t/p/w200${item.poster_path}` : '/images/placeholder2.jpg' %>" alt="Poster za <%= item.title || item.name %>">
                            </div>
                            <div class="movie-details">
                                <h2 class="movie-title-full">
                                    <%= item.title || item.name %>
                                    <% if (item.release_date || item.first_air_date) { %>
                                        (<%= (item.release_date || item.first_air_date).substr(0, 4) %>)
                                    <% } %>
                                </h2>
                                <p><%= item.overview %></p>
                            </div>             
                        </div>
                    </a>
                <% }) %>
            </div>

            <% if (loadMore) { %>
                <button id="load-more" data-next="<%= nextPage %>">Load More</button>
            <% } %>
        <% } else { %>
            <p>Nema dostupnih podataka.</p>
        <% } %>
    </main>

    <%- include('partials/footer') %>

    <script>
        document.getElementById("load-more")?.addEventListener("click", function() {
            const nextPage = this.getAttribute("data-next");
            fetch(`${window.location.pathname}?page=${nextPage}`)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const newMovies = doc.querySelector(".movie-grid")?.innerHTML;
                if (newMovies) {
                    document.querySelector(".movie-grid").innerHTML += newMovies;
                }
                
                const newLoadMore = doc.querySelector("#load-more");
                if (newLoadMore) {
                    this.setAttribute("data-next", newLoadMore.getAttribute("data-next"));
                } else {
                    this.remove();
                }
            })
            .catch(error => console.error("Load More Error:", error));
        });

        document.addEventListener("DOMContentLoaded", function () {
            const descriptions = document.querySelectorAll(".movie-details p");
    
            descriptions.forEach(function (description) {
                const maxLength = 175; 
                let text = description.textContent.trim();
    
                if (text.length > maxLength) {
                    let truncatedText = text.substr(0, maxLength);
                    truncatedText = truncatedText.substr(0, Math.min(truncatedText.length, truncatedText.lastIndexOf(" ")));
                    description.textContent = truncatedText + "...";
                }
            });
    
            const titles = document.querySelectorAll(".movie-title-full, .movie-title-mobile");
    
            titles.forEach(function (title) {
                const maxWords = 15; 
                let text = title.textContent.trim();

                const yearMatch = text.match(/\((\d{4})\)$/);
                let titleWithoutYear = yearMatch ? text.substring(0, text.lastIndexOf('(')).trim() : text;
                let words = titleWithoutYear.split(" ");

                if (words.length > maxWords) {
                    let truncatedTitle = words.slice(0, maxWords).join(" ");
                    title.textContent = truncatedTitle + "..." + (yearMatch ? ` (${yearMatch[1]})` : "");
                } else {
                    title.textContent = titleWithoutYear + (yearMatch ? ` (${yearMatch[1]})` : "");
                }
            });
        });
    </script>
</body>
</html>
